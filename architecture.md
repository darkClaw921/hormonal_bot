# Архитектура проекта Hormonal Bot

## Структура проекта

```
hormonal_bot/
├── bot/                    # Основной модуль бота
│   ├── __init__.py
│   └── config.py          # Конфигурация и переменные окружения
├── handlers/              # Обработчики сообщений и команд
│   ├── __init__.py
│   ├── start.py           # Обработчик команды /start и партнерских приглашений
│   ├── menu.py            # Обработчики кнопок главного меню
│   ├── cycle_input.py     # Обработчик ввода дня цикла
│   ├── partners.py        # Обработчики управления партнерами
│   └── settings.py        # Обработчики настроек пользователя
├── routers/               # Роутеры для организации обработчиков
│   └── __init__.py        # Главный роутер, объединяющий все обработчики
├── services/              # Бизнес-логика и сервисы
│   ├── __init__.py
│   ├── cycle_service.py  # Сервис расчета фаз менструального цикла
│   ├── phase_formatter.py # Форматирование информации о фазах цикла
│   ├── partner_service.py # Сервис для работы с партнерами
│   ├── notification_service.py # Сервис для отправки уведомлений
│   └── statistics_service.py # Сервис для расчета статистики циклов
├── database/              # Модели базы данных и миграции
│   ├── __init__.py
│   ├── base.py            # Базовый класс для моделей SQLAlchemy
│   ├── engine.py           # Настройка подключения к БД (engine, sessionmaker)
│   └── models.py           # Модели данных (User, Partner, CycleEntry, Notification)
├── keyboards/             # Inline и Reply клавиатуры
│   ├── __init__.py
│   ├── main.py            # Главное меню (reply клавиатура)
│   ├── partners.py        # Клавиатуры для управления партнерами
│   ├── cycle_input.py     # Inline клавиатура для выбора фазы цикла
│   └── settings.py        # Inline клавиатуры для настроек
├── middlewares/           # Middleware для обработки запросов
│   ├── __init__.py
│   └── database.py        # Middleware для инжекции сессии БД в handlers
├── utils/                 # Вспомогательные утилиты
│   └── __init__.py
├── tasks/                 # Задачи для планировщика (APScheduler)
│   ├── __init__.py
│   └── notifications.py   # Задачи для отправки уведомлений
├── tests/                 # Тесты проекта
│   ├── __init__.py
│   ├── conftest.py        # Конфигурация pytest и фикстуры для тестов
│   ├── unit/              # Unit тесты
│   │   ├── __init__.py
│   │   ├── test_cycle_service.py # Unit тесты для cycle_service
│   │   └── test_models.py  # Unit тесты для моделей БД
│   └── integration/       # Интеграционные тесты
│       ├── __init__.py
│       └── test_user_scenarios.py # Интеграционные тесты основных сценариев
├── main.py                # Точка входа в приложение
├── pyproject.toml         # Конфигурация проекта и зависимости
├── alembic.ini            # Конфигурация Alembic для миграций
├── alembic/               # Директория миграций Alembic
│   ├── __init__.py
│   ├── env.py             # Конфигурация окружения Alembic для async
│   ├── script.py.mako     # Шаблон для создания миграций
│   └── versions/          # Директория с файлами миграций
└── README.md              # Документация проекта
```

## Описание модулей

### bot/
Основной модуль бота, содержащий конфигурацию и инициализацию.

- **config.py**: Класс Config для загрузки переменных окружения (BOT_TOKEN, DATABASE_URL, LOG_LEVEL), функция setup_logging для настройки логирования.

### handlers/
Обработчики сообщений и команд от пользователей. Содержит функции-обработчики для различных типов сообщений и команд бота.

- **start.py**: Обработчик команды /start. Регистрирует нового пользователя в БД или приветствует существующего, обрабатывает партнерские приглашения через deep linking (/start partner_<user_id>), показывает главное меню или партнерский интерфейс. Содержит функцию show_partner_interface для отображения информации о текущей фазе цикла партнера. При обработке партнерских приглашений и отображении партнерского интерфейса использует функцию get_partner_explanation_text для показа объяснялки партнеру. Использует фильтр Command из aiogram.filters для обработки команд.
- **menu.py**: Обработчики кнопок главного меню ("Мой цикл", "Ввести день цикла", "Настройки"). Обработчик "Мой цикл" показывает статистику циклов пользователя через StatisticsService. Обработчик "Ввести день цикла" показывает inline клавиатуру с кнопками быстрого выбора фазы. Обработчик "Настройки" показывает меню настроек с текущими значениями. Использует магические фильтры F (F.text == "...") для фильтрации текстовых сообщений.
- **cycle_input.py**: Обработчики ввода дня цикла. Содержит обработчик текстового ввода дня цикла (валидирует ввод от 1 до 35 через lambda фильтр), определяет фазу цикла через CycleService, сохраняет запись в БД и показывает отформатированную информацию о фазе через PhaseFormatter. Также содержит callback обработчики для inline кнопок выбора фазы (handle_phase_selection с фильтром F.data.startswith("phase_")), обработку кнопок "Ввести число" и "Пропустить", функцию calculate_day_from_phase для расчета дня цикла на основе выбранной фазы (использует средний день фазы), функцию save_cycle_entry для сохранения записи о дне цикла в БД.
- **partners.py**: Обработчики управления партнерами. Содержит обработчики для добавления партнера (запрос Telegram ID или username, генерация ссылки-приглашения), удаления партнера (список с подтверждением), показа списка партнеров, команды /partner для партнеров, callback обработчики для inline кнопок управления партнерами. Содержит функцию get_partner_explanation_text для генерации объяснялки для партнера с информацией о том, что он будет получать уведомления о фазах цикла. Использует магические фильтры F (F.text == "...") для текстовых сообщений и lambda функции для callback queries.
- **settings.py**: Обработчики настроек пользователя. Содержит callback обработчики для управления настройками: переключение уведомлений (settings_notifications_toggle), выбор длины цикла (settings_cycle_length_*), выбор времени уведомлений (settings_time_*), возврат в главное меню (settings_back). Использует магические фильтры F (F.data == "..." и F.data.startswith("...")) для фильтрации callback queries.

### routers/
Роутеры для организации обработчиков по функциональным группам. Позволяет структурировать код и разделять обработчики по модулям.

- **__init__.py**: Главный роутер (main_router), который объединяет все обработчики из handlers/ (start, menu, partners, cycle_input, settings) и подключается к диспетчеру в main.py.

### services/
Бизнес-логика приложения. Содержит сервисы для работы с данными пользователей, расчета фаз цикла, управления уведомлениями и партнерами.

- **cycle_service.py**: Сервис расчета фаз менструального цикла. Класс CycleService с методами:
  - `calculate_cycle_day()`: Рассчитывает день цикла от последней менструации
  - `determine_phase()`: Определяет фазу цикла по номеру дня
  - `get_phase_info()`: Получает полную информацию о фазе (PhaseInfo)
  - `is_phase_transition()`: Определяет переход в новую фазу
  - `get_phase_boundaries()`: Получает границы фаз для заданной длины цикла
  - Enum CyclePhase: Фазы цикла (менструальная, постменструальная, овуляторная, постовуляторная, ПМС)
  - Dataclass PhaseInfo: Информация о фазе (phase, day_number, phase_start_day, phase_end_day, cycle_length)

- **phase_formatter.py**: Форматирование информации о фазах цикла. Класс PhaseFormatter с методами:
  - `format_phase_info()`: Форматирует полную информацию о фазе в читаемый текст с markdown разметкой
  - `format_short_phase_info()`: Форматирует краткую информацию о фазе
  - Содержит структурированные данные о каждой фазе (описание, самочувствие, физическая активность, питание, советы для партнера)

- **partner_service.py**: Сервис для работы с партнерами пользователя. Класс PartnerService с методами:
  - `add_partner()`: Добавляет партнера к пользователю (проверяет на дубликаты и самоприсвоение)
  - `remove_partner()`: Удаляет партнера у пользователя
  - `get_partners()`: Получает список всех партнеров пользователя
  - `get_partner_by_telegram_id()`: Получает партнера по его Telegram ID
  - `get_user_by_partner_telegram_id()`: Получает пользователя по Telegram ID его партнера

- **notification_service.py**: Сервис для отправки уведомлений пользователям и партнерам. Класс NotificationService с методами:
  - `send_phase_change_notification()`: Отправляет уведомление пользователю о переходе в новую фазу
  - `send_partner_phase_change_notification()`: Отправляет уведомление партнеру о переходе пользователя в новую фазу
  - `send_weekly_reminder()`: Отправляет еженедельное напоминание пользователю о вводе дня цикла
  - `check_and_notify_phase_transitions()`: Проверяет всех пользователей на переход в новую фазу и отправляет уведомления
  - `send_weekly_reminders_to_all()`: Отправляет еженедельные напоминания всем пользователям с включенными уведомлениями

- **statistics_service.py**: Сервис для расчета статистики менструального цикла. Класс StatisticsService с методами:
  - `get_user_statistics()`: Получает статистику пользователя (количество циклов, средняя длина, текущий день и фаза, история циклов)
  - `_identify_cycles()`: Определяет циклы из записей CycleEntry (новый цикл начинается при возврате day_number к 1-3)
  - `format_statistics()`: Форматирует статистику для отображения пользователю
  - Dataclass CycleStats: Статистика одного цикла (start_date, end_date, length, entries_count)
  - Dataclass UserStatistics: Общая статистика пользователя (total_cycles, average_cycle_length, current_cycle_day, current_phase, cycles_history, total_entries)

### database/
Модели базы данных (SQLAlchemy ORM) и миграции (Alembic). Определяет структуру таблиц и связи между ними.

- **base.py**: Базовый класс Base с AsyncAttrs и DeclarativeBase для всех моделей с поддержкой async операций.
- **engine.py**: Настройка async engine и async_sessionmaker для подключения к БД. Функции get_async_database_url для преобразования синхронных URL в async, init_db для инициализации БД, close_db для закрытия соединений.
- **models.py**: Модели данных:
  - **User**: Пользователь бота (telegram_id, username, cycle_length, last_period_date, notification_enabled, notification_time, created_at)
  - **Partner**: Партнер пользователя для получения уведомлений (telegram_id, username, user_id FK, created_at)
  - **CycleEntry**: Запись о дне цикла (user_id FK, day_number, entry_date, phase, created_at)
  - **Notification**: Уведомление пользователя или партнера (user_id FK, partner_id FK nullable, notification_type, sent_at)

### keyboards/
Inline и Reply клавиатуры для взаимодействия с пользователем. Содержит функции для создания клавиатур с кнопками.

- **main.py**: Функции для создания главного меню (get_main_menu) с кнопками "Мой цикл", "Ввести день цикла", "Партнеры", "Настройки", и функция для удаления клавиатуры (get_remove_keyboard).

- **partners.py**: Клавиатуры для управления партнерами. Содержит функции:
  - `get_partners_menu()`: Reply клавиатура меню управления партнерами (добавить, список, главное меню)
  - `get_partners_list_keyboard()`: Inline клавиатура со списком партнеров для удаления
  - `get_confirm_remove_partner_keyboard()`: Inline клавиатура подтверждения удаления партнера
  - `get_partner_info_keyboard()`: Inline клавиатура для партнерского интерфейса (обновить информацию)

- **cycle_input.py**: Inline клавиатура для быстрого выбора фазы цикла. Содержит функцию:
  - `get_phase_selection_keyboard()`: Создает inline клавиатуру с кнопками основных фаз (Менструация, После менструации, Овуляция, ПМС), кнопкой "Ввести число" для ручного ввода и кнопкой "Пропустить"

- **settings.py**: Inline клавиатуры для настроек пользователя. Содержит функции:
  - `get_settings_keyboard()`: Главная клавиатура настроек (уведомления, длина цикла, время уведомлений, назад)
  - `get_notifications_toggle_keyboard()`: Клавиатура для переключения уведомлений (включить/выключить, назад)
  - `get_cycle_length_keyboard()`: Клавиатура для выбора длины цикла (26-35 дней, назад)
  - `get_notification_time_keyboard()`: Клавиатура для выбора времени уведомлений (08:00-21:00, назад)

### middlewares/
Middleware для обработки запросов перед их передачей в обработчики. Может включать аутентификацию, логирование, обработку ошибок.

- **database.py**: DatabaseMiddleware для создания и инжекции сессии БД в handlers. Автоматически создает сессию перед выполнением handler, коммитит изменения при успехе, откатывает транзакцию при ошибке и гарантирует закрытие сессии после выполнения.

### utils/
Вспомогательные утилиты и функции общего назначения. Вспомогательные функции для работы с датами, форматирования текста и других задач.

### tasks/
Задачи для планировщика APScheduler. Содержит функции для периодических задач, таких как отправка уведомлений пользователям и партнерам.

- **notifications.py**: Задачи планировщика для отправки уведомлений:
  - `check_phase_transitions_task()`: Задача для проверки переходов в новую фазу и отправки уведомлений (выполняется ежедневно)
  - `send_weekly_reminders_task()`: Задача для отправки еженедельных напоминаний пользователям (выполняется раз в неделю)

### tasks/
Задачи для планировщика APScheduler. Содержит функции для периодических задач, таких как отправка уведомлений пользователям и партнерам.

- **notifications.py**: Задачи планировщика для отправки уведомлений:
  - `check_phase_transitions_task()`: Задача для проверки переходов в новую фазу и отправки уведомлений (выполняется ежедневно)
  - `send_weekly_reminders_task()`: Задача для отправки еженедельных напоминаний пользователям (выполняется раз в неделю)

### tests/
Тесты проекта. Содержит unit и интеграционные тесты для проверки функциональности приложения.

- **conftest.py**: Конфигурация pytest и фикстуры для тестов. Содержит фикстуры:
  - `event_loop`: Создает event loop для async тестов
  - `test_db_session`: Создает тестовую in-memory базу данных и сессию для каждого теста
  - `test_user`: Создает тестового пользователя
  - `test_partner`: Создает тестового партнера для пользователя

- **unit/**: Unit тесты для отдельных компонентов:
  - **test_cycle_service.py**: Unit тесты для CycleService. Тестирует методы calculate_cycle_day, determine_phase, get_phase_info, is_phase_transition, get_phase_boundaries для различных сценариев (нормальные условия, граничные случаи, невалидные данные, разные длины циклов)
  - **test_models.py**: Unit тесты для моделей БД. Тестирует создание моделей (User, Partner, CycleEntry, Notification), связи между моделями, каскадное удаление, значения по умолчанию

- **integration/**: Интеграционные тесты для основных сценариев использования:
  - **test_user_scenarios.py**: Интеграционные тесты основных сценариев:
    - Регистрация пользователя (с датой последней менструации и без)
    - Ввод дня цикла (создание записи, множественные записи, определение перехода фазы)
    - Управление партнерами (добавление, удаление, получение списка, проверка дубликатов и самоприсвоения)
    - Получение статистики (пустой пользователь, пользователь с записями)

### main.py
Точка входа в приложение. Функция main() инициализирует логирование, валидирует конфигурацию, инициализирует БД, создает бота и диспетчер, подключает DatabaseMiddleware и роутеры, настраивает AsyncIOScheduler из apscheduler.schedulers.asyncio для периодических задач (проверка переходов фаз ежедневно через add_job с IntervalTrigger(days=1), еженедельные напоминания через add_job с IntervalTrigger(weeks=1)), запускает планировщик через scheduler.start(), запускает polling через dp.start_polling(bot). При завершении останавливает планировщик через scheduler.shutdown(), закрывает соединения с БД и сессию бота.

## Зависимости

- **aiogram** (>=3.23.0): Асинхронный фреймворк для создания Telegram ботов
- **sqlalchemy** (>=2.0.0): ORM для работы с базой данных
- **apscheduler** (>=3.10.0): Планировщик задач для отправки уведомлений
- **python-dotenv** (>=1.0.0): Загрузка переменных окружения из .env файла
- **alembic** (>=1.13.0): Миграции базы данных
- **aiosqlite** (>=0.19.0): Асинхронный драйвер для SQLite

### Зависимости для разработки (dev)

- **pytest** (>=8.0.0): Фреймворк для написания и запуска тестов
- **pytest-asyncio** (>=0.23.0): Плагин pytest для поддержки async тестов
- **pytest-mock** (>=3.14.0): Плагин pytest для создания моков

## Конфигурация

Конфигурация загружается из переменных окружения через файл `.env`:
- `BOT_TOKEN`: Токен Telegram бота
- `DATABASE_URL`: URL подключения к базе данных
- `LOG_LEVEL`: Уровень логирования (DEBUG, INFO, WARNING, ERROR, CRITICAL)
- `DEBUG`: Режим отладки (true/false)
